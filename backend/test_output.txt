============================= test session starts ==============================
platform linux -- Python 3.12.4, pytest-8.3.0, pluggy-1.6.0 -- /usr/local/bin/python
cachedir: .pytest_cache
rootdir: /app
configfile: pytest.ini
plugins: Faker-33.1.0, anyio-4.12.0, asyncio-0.24.0, cov-7.0.0
asyncio: mode=Mode.AUTO, default_loop_scope=session
collecting ... collected 4 items

tests/integration/test_order_state_machine.py::test_order_state_transitions_success ERROR [ 25%]
tests/integration/test_order_state_machine.py::test_invalid_state_transition FAILED [ 50%]
tests/integration/test_order_state_machine.py::test_idempotent_transition FAILED [ 75%]
tests/integration/test_order_state_machine.py::test_terminal_state_reopen_forbidden FAILED [100%]

==================================== ERRORS ====================================
____________ ERROR at setup of test_order_state_transitions_success ____________
file /app/tests/integration/test_order_state_machine.py, line 10
  @pytest.mark.asyncio
  async def test_order_state_transitions_success(test_client: AsyncClient, user_token: dict, session):
      """
      Verifica el flujo completo de vida de un pedido:
      PENDING -> CONFIRMED -> PREPARING -> READY -> DELIVERED
      """
      headers = {"Authorization": f"Bearer {user_token}"}

      # 1. Crear Pedido (PENDING por defecto)
      payload = {
          "branch_id": 1,
          "items": [
              {"product_id": 1, "quantity": 1}
          ]
      }
      response = await test_client.post("/orders/", json=payload, headers=headers)
      assert response.status_code == 201
      order_id = response.json()["id"]
      assert response.json()["status"] == "pending" # pending is default if paid < total (which it is, 0 < 5.0)

      # 2. Transición PENDING -> CONFIRMED
      response = await test_client.patch(
          f"/orders/{order_id}/status",
          json={"status": "confirmed"},
          headers=headers
      )
      assert response.status_code == 200
      assert response.json()["status"] == "confirmed"

      # Verificar Auditoría
      result = await session.execute(select(OrderAudit).where(OrderAudit.order_id == order_id))
      audits = result.scalars().all()
      assert len(audits) >= 1
      latest = audits[-1]
      assert latest.old_status == "pending"
      assert latest.new_status == "confirmed"

      # 3. Transición CONFIRMED -> PREPARING
      response = await test_client.patch(
          f"/orders/{order_id}/status",
          json={"status": "preparing"},
          headers=headers
      )
      assert response.status_code == 200
      assert response.json()["status"] == "preparing"

      # 4. Transición PREPARING -> READY
      response = await test_client.patch(
          f"/orders/{order_id}/status",
          json={"status": "ready"},
          headers=headers
      )
      assert response.status_code == 200

      # 5. Transición READY -> DELIVERED
      response = await test_client.patch(
          f"/orders/{order_id}/status",
          json={"status": "delivered"},
          headers=headers
      )
      assert response.status_code == 200
      assert response.json()["status"] == "delivered"
E       fixture 'session' not found
>       available fixtures: _session_event_loop, _session_faker, anyio_backend, anyio_backend_name, anyio_backend_options, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, cov, db_session, db_session_factory, doctest_namespace, event_loop, event_loop_policy, faker, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, mock_category, mock_product, mock_redis, monkeypatch, no_cover, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, setup_database, test_branch, test_category, test_category_company_2, test_client, test_company, test_company_2, test_permission, test_permission_category, test_product, test_product_company_2, test_products_batch, test_role, test_role_permission, test_user, test_user_company_2, tests/integration/test_order_state_machine.py::<event_loop>, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory, user_token
>       use 'pytest --fixtures [testpath]' for help on them.

/app/tests/integration/test_order_state_machine.py:10
------------------------------ Captured log setup ------------------------------
WARNING  passlib.handlers.bcrypt:bcrypt.py:622 (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/passlib/handlers/bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
=================================== FAILURES ===================================
________________________ test_invalid_state_transition _________________________
tests/integration/test_order_state_machine.py:88: in test_invalid_state_transition
    order_id = response.json()["id"]
E   KeyError: 'id'
----------------------------- Captured stdout call -----------------------------
{"timestamp": null, "level": null, "module": "main", "message": "Request started", "taskName": "Task-14", "method": "POST", "url": "http://test/orders/", "client_ip": "127.0.0.1", "user_agent": "python-httpx/0.28.1", "path": "/orders/", "query_params": ""}
2026-01-01 19:35:00,841 INFO sqlalchemy.engine.Engine select pg_catalog.version()
2026-01-01 19:35:00,841 INFO sqlalchemy.engine.Engine [raw sql] ()
2026-01-01 19:35:00,842 INFO sqlalchemy.engine.Engine select current_schema()
2026-01-01 19:35:00,842 INFO sqlalchemy.engine.Engine [raw sql] ()
2026-01-01 19:35:00,844 INFO sqlalchemy.engine.Engine show standard_conforming_strings
2026-01-01 19:35:00,844 INFO sqlalchemy.engine.Engine [raw sql] ()
2026-01-01 19:35:00,845 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-01-01 19:35:00,846 INFO sqlalchemy.engine.Engine SELECT users.id, users.company_id, users.branch_id, users.role_id, users.username, users.email, users.hashed_password, users.full_name, users.role, users.is_active, users.created_at, users.updated_at, users.last_login 
FROM users 
WHERE users.id = $1::INTEGER
2026-01-01 19:35:00,847 INFO sqlalchemy.engine.Engine [generated in 0.00012s] (87,)
2026-01-01 19:35:00,854 INFO sqlalchemy.engine.Engine SELECT products.id, products.company_id, products.name, products.description, products.price, products.tax_rate, products.stock, products.image_url, products.is_active, products.created_at, products.updated_at, products.category_id 
FROM products 
WHERE products.id IN ($2::INTEGER) AND products.company_id = $1::INTEGER AND products.is_active = true
2026-01-01 19:35:00,854 INFO sqlalchemy.engine.Engine [generated in 0.00025s] (265, 1)
2026-01-01 19:35:00,857 INFO sqlalchemy.engine.Engine ROLLBACK
{"timestamp": null, "level": null, "module": "main", "message": "Request completed", "taskName": "Task-14", "method": "POST", "url": "http://test/orders/", "status_code": 400, "duration_ms": 51.8, "path": "/orders/"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:1846 select pg_catalog.version()
INFO     sqlalchemy.engine.Engine:base.py:1846 [raw sql] ()
INFO     sqlalchemy.engine.Engine:base.py:1846 select current_schema()
INFO     sqlalchemy.engine.Engine:base.py:1846 [raw sql] ()
INFO     sqlalchemy.engine.Engine:base.py:1846 show standard_conforming_strings
INFO     sqlalchemy.engine.Engine:base.py:1846 [raw sql] ()
INFO     sqlalchemy.engine.Engine:base.py:2701 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.company_id, users.branch_id, users.role_id, users.username, users.email, users.hashed_password, users.full_name, users.role, users.is_active, users.created_at, users.updated_at, users.last_login 
FROM users 
WHERE users.id = $1::INTEGER
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00012s] (87,)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT products.id, products.company_id, products.name, products.description, products.price, products.tax_rate, products.stock, products.image_url, products.is_active, products.created_at, products.updated_at, products.category_id 
FROM products 
WHERE products.id IN ($2::INTEGER) AND products.company_id = $1::INTEGER AND products.is_active = true
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00025s] (265, 1)
INFO     sqlalchemy.engine.Engine:base.py:2704 ROLLBACK
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/orders/ "HTTP/1.1 400 Bad Request"
__________________________ test_idempotent_transition __________________________
tests/integration/test_order_state_machine.py:113: in test_idempotent_transition
    order_id = response.json()["id"]
E   KeyError: 'id'
----------------------------- Captured stdout call -----------------------------
{"timestamp": null, "level": null, "module": "main", "message": "Request started", "taskName": "Task-29", "method": "POST", "url": "http://test/orders/", "client_ip": "127.0.0.1", "user_agent": "python-httpx/0.28.1", "path": "/orders/", "query_params": ""}
2026-01-01 19:35:01,550 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-01-01 19:35:01,550 INFO sqlalchemy.engine.Engine SELECT users.id, users.company_id, users.branch_id, users.role_id, users.username, users.email, users.hashed_password, users.full_name, users.role, users.is_active, users.created_at, users.updated_at, users.last_login 
FROM users 
WHERE users.id = $1::INTEGER
2026-01-01 19:35:01,550 INFO sqlalchemy.engine.Engine [cached since 0.704s ago] (88,)
2026-01-01 19:35:01,553 INFO sqlalchemy.engine.Engine SELECT products.id, products.company_id, products.name, products.description, products.price, products.tax_rate, products.stock, products.image_url, products.is_active, products.created_at, products.updated_at, products.category_id 
FROM products 
WHERE products.id IN ($2::INTEGER) AND products.company_id = $1::INTEGER AND products.is_active = true
2026-01-01 19:35:01,553 INFO sqlalchemy.engine.Engine [cached since 0.6996s ago] (266, 1)
2026-01-01 19:35:01,554 INFO sqlalchemy.engine.Engine ROLLBACK
{"timestamp": null, "level": null, "module": "main", "message": "Request completed", "taskName": "Task-29", "method": "POST", "url": "http://test/orders/", "status_code": 400, "duration_ms": 8.29, "path": "/orders/"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2701 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.company_id, users.branch_id, users.role_id, users.username, users.email, users.hashed_password, users.full_name, users.role, users.is_active, users.created_at, users.updated_at, users.last_login 
FROM users 
WHERE users.id = $1::INTEGER
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.704s ago] (88,)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT products.id, products.company_id, products.name, products.description, products.price, products.tax_rate, products.stock, products.image_url, products.is_active, products.created_at, products.updated_at, products.category_id 
FROM products 
WHERE products.id IN ($2::INTEGER) AND products.company_id = $1::INTEGER AND products.is_active = true
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.6996s ago] (266, 1)
INFO     sqlalchemy.engine.Engine:base.py:2704 ROLLBACK
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/orders/ "HTTP/1.1 400 Bad Request"
_____________________ test_terminal_state_reopen_forbidden _____________________
tests/integration/test_order_state_machine.py:145: in test_terminal_state_reopen_forbidden
    order_id = res.json()["id"]
E   KeyError: 'id'
----------------------------- Captured stdout call -----------------------------
{"timestamp": null, "level": null, "module": "main", "message": "Request started", "taskName": "Task-44", "method": "POST", "url": "http://test/orders/", "client_ip": "127.0.0.1", "user_agent": "python-httpx/0.28.1", "path": "/orders/", "query_params": ""}
2026-01-01 19:35:01,954 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2026-01-01 19:35:01,954 INFO sqlalchemy.engine.Engine SELECT users.id, users.company_id, users.branch_id, users.role_id, users.username, users.email, users.hashed_password, users.full_name, users.role, users.is_active, users.created_at, users.updated_at, users.last_login 
FROM users 
WHERE users.id = $1::INTEGER
2026-01-01 19:35:01,954 INFO sqlalchemy.engine.Engine [cached since 1.108s ago] (89,)
2026-01-01 19:35:01,956 INFO sqlalchemy.engine.Engine SELECT products.id, products.company_id, products.name, products.description, products.price, products.tax_rate, products.stock, products.image_url, products.is_active, products.created_at, products.updated_at, products.category_id 
FROM products 
WHERE products.id IN ($2::INTEGER) AND products.company_id = $1::INTEGER AND products.is_active = true
2026-01-01 19:35:01,956 INFO sqlalchemy.engine.Engine [cached since 1.102s ago] (267, 1)
2026-01-01 19:35:01,957 INFO sqlalchemy.engine.Engine ROLLBACK
{"timestamp": null, "level": null, "module": "main", "message": "Request completed", "taskName": "Task-44", "method": "POST", "url": "http://test/orders/", "status_code": 400, "duration_ms": 5.53, "path": "/orders/"}
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2701 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.company_id, users.branch_id, users.role_id, users.username, users.email, users.hashed_password, users.full_name, users.role, users.is_active, users.created_at, users.updated_at, users.last_login 
FROM users 
WHERE users.id = $1::INTEGER
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 1.108s ago] (89,)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT products.id, products.company_id, products.name, products.description, products.price, products.tax_rate, products.stock, products.image_url, products.is_active, products.created_at, products.updated_at, products.category_id 
FROM products 
WHERE products.id IN ($2::INTEGER) AND products.company_id = $1::INTEGER AND products.is_active = true
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 1.102s ago] (267, 1)
INFO     sqlalchemy.engine.Engine:base.py:2704 ROLLBACK
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/orders/ "HTTP/1.1 400 Bad Request"
---------------------------- Captured log teardown -----------------------------
INFO     conftest:conftest.py:91 ℹ️ Manteniendo base de datos PostgreSQL activa después de los tests.
=========================== short test summary info ============================
FAILED tests/integration/test_order_state_machine.py::test_invalid_state_transition - KeyError: 'id'
FAILED tests/integration/test_order_state_machine.py::test_idempotent_transition - KeyError: 'id'
FAILED tests/integration/test_order_state_machine.py::test_terminal_state_reopen_forbidden - KeyError: 'id'
ERROR tests/integration/test_order_state_machine.py::test_order_state_transitions_success
========================== 3 failed, 1 error in 3.64s ==========================
