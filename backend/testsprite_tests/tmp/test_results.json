[
  {
    "projectId": "21464c86-d59a-471a-acf0-ff84d9556c3a",
    "testId": "bdbe3956-d512-4475-ac4f-7f054d9d1c97",
    "userId": "c4f8c448-d081-703d-d7fc-4e8909bea56a",
    "title": "TC004-inventory_stock_deduction_using_fifo_and_recipe_logic",
    "description": "Ensure that inventory stock levels are automatically and accurately deducted using FIFO method, including recipe-based and modifier-based deductions during sales.",
    "code": "import requests\nimport uuid\n\nBASE_URL = \"http://localhost:8000\"\nTIMEOUT = 30\nHEADERS = {\"Content-Type\": \"application/json\"}\n\ndef test_inventory_stock_deduction_using_fifo_and_recipe_logic():\n    # Step 1: Setup - Create ingredient batches with different quantities and batch dates (FIFO)\n    ingredient_id = str(uuid.uuid4())\n    batch_1 = {\n        \"ingredient_id\": ingredient_id,\n        \"quantity\": 100,\n        \"batch_date\": \"2026-01-01T00:00:00Z\"\n    }\n    batch_2 = {\n        \"ingredient_id\": ingredient_id,\n        \"quantity\": 50,\n        \"batch_date\": \"2026-01-10T00:00:00Z\"\n    }\n    created_batches = []\n\n    try:\n        # Create batch 1\n        resp = requests.post(f\"{BASE_URL}/inventory/ingredient_batches\", json=batch_1, headers=HEADERS, timeout=TIMEOUT)\n        assert resp.status_code == 201, f\"Failed to create batch 1: {resp.text}\"\n        batch_1_resp = resp.json()\n        created_batches.append(batch_1_resp)\n\n        # Create batch 2\n        resp = requests.post(f\"{BASE_URL}/inventory/ingredient_batches\", json=batch_2, headers=HEADERS, timeout=TIMEOUT)\n        assert resp.status_code == 201, f\"Failed to create batch 2: {resp.text}\"\n        batch_2_resp = resp.json()\n        created_batches.append(batch_2_resp)\n\n        # Step 2: Setup - Create a recipe using the ingredient with required quantity 120 (to trigger FIFO usage)\n        recipe_id = str(uuid.uuid4())\n        recipe_payload = {\n            \"id\": recipe_id,\n            \"name\": \"Test Recipe\",\n            \"ingredients\": [\n                {\n                    \"ingredient_id\": ingredient_id,\n                    \"quantity\": 120\n                }\n            ],\n            \"modifiers\": []\n        }\n        resp = requests.post(f\"{BASE_URL}/recipes\", json=recipe_payload, headers=HEADERS, timeout=TIMEOUT)\n        assert resp.status_code == 201, f\"Failed to create recipe: {resp.text}\"\n\n        # Step 3: Create an order including this recipe and complete the sale that triggers inventory deduction\n        order_payload = {\n            \"customer_id\": str(uuid.uuid4()),\n            \"items\": [\n                {\n                    \"recipe_id\": recipe_id,\n                    \"quantity\": 1,\n                    \"modifiers\": []\n                }\n            ],\n            \"delivery_type\": \"dine-in\",\n            \"status\": \"completed\"\n        }\n        resp = requests.post(f\"{BASE_URL}/orders\", json=order_payload, headers=HEADERS, timeout=TIMEOUT)\n        assert resp.status_code == 201, f\"Failed to create order: {resp.text}\"\n        order_resp = resp.json()\n        order_id = order_resp.get(\"id\")\n        assert order_id, \"Order ID not returned\"\n\n        # Step 4: Verify inventory deduction using FIFO method:\n        # Query the ingredient batches after order completion to check proper quantity deductions (FIFO)\n        resp = requests.get(f\"{BASE_URL}/inventory/ingredient_batches?ingredient_id={ingredient_id}\", headers=HEADERS, timeout=TIMEOUT)\n        assert resp.status_code == 200, f\"Failed to get ingredient batches after order: {resp.text}\"\n        batches = resp.json()\n        # Sort batches by batch_date ascending to verify FIFO deduction\n        batches_sorted = sorted(batches, key=lambda b: b[\"batch_date\"])\n\n        # Expected: batch_1 reduced from 100 to 0, batch_2 reduced from 50 to 30 (120 total deducted)\n        batch1_after = next((b for b in batches_sorted if b[\"id\"] == batch_1_resp[\"id\"]), None)\n        batch2_after = next((b for b in batches_sorted if b[\"id\"] == batch_2_resp[\"id\"]), None)\n        assert batch1_after is not None, \"Batch 1 missing after deduction\"\n        assert batch2_after is not None, \"Batch 2 missing after deduction\"\n\n        assert batch1_after[\"quantity\"] == 0, f\"Batch 1 quantity expected 0 but got {batch1_after['quantity']}\"\n        assert batch2_after[\"quantity\"] == 30, f\"Batch 2 quantity expected 30 but got {batch2_after['quantity']}\"\n\n    finally:\n        # Cleanup: delete order, recipe, and ingredient batches\n        if 'order_id' in locals():\n            requests.delete(f\"{BASE_URL}/orders/{order_id}\", headers=HEADERS, timeout=TIMEOUT)\n        if 'recipe_id' in locals():\n            requests.delete(f\"{BASE_URL}/recipes/{recipe_id}\", headers=HEADERS, timeout=TIMEOUT)\n        for batch in created_batches:\n            requests.delete(f\"{BASE_URL}/inventory/ingredient_batches/{batch['id']}\", headers=HEADERS, timeout=TIMEOUT)\n\ntest_inventory_stock_deduction_using_fifo_and_recipe_logic()\n",
    "testStatus": "FAILED",
    "testError": "Traceback (most recent call last):\n  File \"/var/task/handler.py\", line 258, in run_with_retry\n    exec(code, exec_env)\n  File \"<string>\", line 97, in <module>\n  File \"<string>\", line 26, in test_inventory_stock_deduction_using_fifo_and_recipe_logic\nAssertionError: Failed to create batch 1: {\"detail\":\"Method Not Allowed\"}\n",
    "testType": "BACKEND",
    "createFrom": "mcp",
    "created": "2026-02-05T19:34:36.148Z",
    "modified": "2026-02-05T19:35:24.282Z"
  }
]
