FastOps V5.0 – Especificación Técnica: Módulo CRM y Lógica de Delivery

Versión: 5.1 (Actualizado: Geolocalización Interactiva)

Fecha: Enero 2026

Autor: Robert Arquitecto

Estado: Aprobado para Implementación Inmediata (Fase 2)

1. RESUMEN EJECUTIVO DEL CAMBIO

1.1 El Problema (Diagnóstico V4.0)

El sistema actual (V4.0) es robusto en control interno (inventario, recetas, caja), pero es ciego hacia el exterior. Carece de entidades para representar al Cliente Final (Customer) y sus Ubicaciones (Address). Esto hace inviable la operación de la PWA de domicilios y la fidelización de clientes, ya que una orden no puede existir sin un destino físico o un titular recurrente.

1.2 La Solución (Alcance V5.0)

Se introduce el módulo CRM & Delivery Core. Este módulo permite:

Identificar clientes por número de teléfono (clave única por Tenant).

Almacenar múltiples direcciones por cliente.

Vincular órdenes a clientes específicos.

Persistir la dirección de entrega en la orden (snapshot) para garantizar la integridad histórica.

(Nuevo V5.1) Selección precisa de ubicación mediante mapa interactivo (Pin-drop) para experiencia tipo Uber/Didi.

2. REQUISITOS FUNCIONALES (Nuevos)

2.1 Gestión de Clientes (CRM)

RF-CRM-01: El sistema debe permitir registrar clientes nuevos capturando: Nombre, Teléfono (ID principal), Email (opcional) y Notas.

RF-CRM-02: El registro de clientes debe ser Multi-Tenant. Un cliente registrado en la empresa "A" no es visible ni accesible desde la empresa "B".

RF-CRM-03: El sistema debe permitir buscar clientes por número de teléfono en tiempo real (para Call Center/Caja).

2.2 Gestión de Direcciones (Address Book)

RF-ADDR-01: Un cliente puede tener N direcciones guardadas (ej. Casa, Oficina, Casa de Novia).

RF-ADDR-02: Cada dirección debe contener: Alias, Dirección descriptiva, Detalles (apto/bloque) y coordenadas opcionales (Lat/Lng).

RF-ADDR-03: El cliente puede seleccionar una dirección predeterminada.

RF-ADDR-04 (Selección por Mapa): El sistema debe ofrecer una interfaz de mapa interactivo en la PWA. El cliente podrá:

Usar GPS para centrar el mapa.

Mover un "Pin" manualmente para fijar la ubicación exacta.

El sistema capturará automáticamente latitude y longitude del pin.

2.3 Lógica de Pedidos (Order Link)

RF-ORD-01: Al crear una orden tipo delivery, es obligatorio asociar un customer_id y una delivery_address.

RF-ORD-02 (Inmutabilidad): La dirección de entrega debe guardarse como texto estático en la tabla de órdenes (delivery_address_snapshot), no solo como referencia a la tabla de direcciones. Razón: Si el cliente edita su dirección "Casa" en el futuro, el pedido antiguo no debe cambiar de lugar.

3. ARQUITECTURA DE DATOS (MODELOS)

Se añaden dos tablas nuevas y se modifica la tabla orders.

3.1 Modelo Customer (Nueva Tabla)

Representa al comprador final.

Campo

Tipo

Restricciones

Descripción

id

Integer

PK, Auto

ID interno.

company_id

Integer

FK, Index

Aislamiento Multi-Tenant.

phone

String

Index, Unique (con company_id)

Identificador principal del usuario.

full_name

String



Nombre del cliente.

email

String

Nullable

Para marketing futuro.

notes

Text

Nullable

Ej: "Cliente alérgico", "Mal pagador".

is_active

Bool

Default True

Soft delete.

3.2 Modelo CustomerAddress (Nueva Tabla)

Lugares de entrega frecuentes del cliente.

Campo

Tipo

Restricciones

Descripción

id

Integer

PK, Auto



customer_id

Integer

FK

Relación con Cliente.

name

String



Alias (Ej. "Casa").

address

String



Dirección formateada o Reverse Geocoding.

details

String

Nullable

Torre, Apto, Bloque.

latitude

Float

Obligatorio si es Pin

Coordenada Y para mapas/repartidores.

longitude

Float

Obligatorio si es Pin

Coordenada X para mapas/repartidores.

3.3 Actualización Modelo Order (Modificación)

Se agregan columnas para soportar la lógica de entrega.

class Order(SQLModel, table=True):
    # ... campos existentes ...
    
    # Nuevos Campos V5.0
    customer_id: Optional[int] = Field(foreign_key="customers.id", index=True)
    delivery_type: str = Field(default="dine_in") # enum: dine_in, takeaway, delivery
    
    # Snapshot de Datos de Entrega (CRÍTICO)
    delivery_address: Optional[str] = Field(None) # Copia textual de la dirección
    delivery_notes: Optional[str] = Field(None)   # Notas específicas del pedido
    delivery_fee: Decimal = Field(default=0)      # Costo del domicilio



4. FLUJOS DE PROCESO (User Journeys)

4.1 Flujo PWA (Cliente desde Casa)

Ingreso: Cliente ingresa a la PWA -> Digita su Teléfono.

Identificación: * Backend verifica phone + company_id.

Si existe: Devuelve token temporal de sesión de cliente.

Si no existe: Solicita Nombre y crea el registro Customer.

Carrito: Cliente selecciona productos.

Checkout (Selección de Ubicación):

Opción A (Guardada): Selecciona "Casa" de su lista.

Opción B (Nueva por Mapa): 1. Clic en "Agregar nueva dirección".
2. Se abre mapa (Google Maps / Mapbox).
3. Cliente mueve el Pin hasta su puerta.
4. Sistema obtiene coords (Lat/Lng).
5. (Opcional) Sistema hace "Reverse Geocoding" para sugerir texto "Calle 123 #45-67".
6. Cliente confirma y agrega detalles ("Apto 202").

Confirmación:

Frontend envía Orden incluyendo address_text y coordenadas.

Backend guarda Orden y copia el texto de la dirección en order.delivery_address.

4.2 Flujo POS/Caja (Pedido Telefónico)

Llamada: Entra llamada, Cajero pregunta teléfono.

Búsqueda: Cajero digita teléfono en POS.

Resultado:

Sistema muestra: "Juan Perez - Último pedido hace 3 días".

Sistema muestra lista de direcciones guardadas.

Acción: Cajero selecciona dirección existente o carga una nueva rápidamente.

5. IMPACTO EN EL DESARROLLO (Roadmap)

Este cambio afecta las fases de desarrollo actuales. Debe priorizarse para desbloquear la PWA.

Fase 2: Motor de Ventas (ACTUALIZADA)

Estado: En curso

$$$$

 Backend - DB: Crear migraciones Alembic para customers y customer_addresses (incluyendo lat/long).

$$$$

 Backend - API: Implementar CustomerRouter (CRUD básico).

$$$$

 Backend - Logic: Actualizar OrderService para aceptar y validar customer_id y datos de entrega.

$$$$

 Seguridad: Implementar un esquema de autenticación ligero para la PWA (basado en teléfono, sin password complejo para MVP).

Fase 3: Logística y PWA

Estado: Pendiente

$$$$

 Frontend PWA: Pantallas de "Quién eres".

$$$$

 Frontend PWA - Mapas: Integrar librería de mapas (Leaflet/Mapbox/Google Maps) para el selector de ubicación "Pin-drop".

$$$$

 Frontend POS: Módulo de búsqueda de clientes en la pantalla de toma de pedidos.

6. CONSIDERACIONES TÉCNICAS Y RIESGOS

Validación de Identidad:

Riesgo: En el MVP, cualquiera puede poner el número de otro.

Mitigación V1: Confianza.

Mitigación V2: Validación simple por WhatsApp OTP (Integración futura).

Duplicidad de Datos:

Regla: El número de teléfono es UNIQUE dentro de cada company_id. Esto evita tener al mismo cliente 3 veces en la base de datos de una sola pizzería.

Privacidad de Datos (GDPR/Habeas Data):

Al guardar datos personales, se debe agregar un check de "Acepto términos y condiciones" en el primer registro de la PWA.

Proveedor de Mapas (Costos):

Google Maps Platform: Mejor calidad, pero costo alto si escala mucho. Requiere API Key.

Mapbox / OpenStreetMap (Recomendado MVP): Opciones gratuitas o mucho más económicas para iniciar. Leaflet es una excelente librería JS gratuita para mostrar mapas OpenStreetMap.
